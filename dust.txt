//booking service
const cancelBookings = async (bookingId: string, customerId: string) => {
  const booking = await pool.query(
    `SELECT * FROM Bookings WHERE id=$1 AND customer_id=$2`,
    [bookingId, customerId]
  );

  if (booking.rows.length === 0) {
    throw new Error("Booking not found for this customer");
  }

  const data = booking.rows[0];
  const today = dayjs().format("YYYY-MM-DD");

  if (dayjs(today).isAfter(dayjs(data.rent_start_date))) {
    throw new Error("Cannot cancel booking after start date");
  }

  // Cancel booking
  const updated = await pool.query(
    `UPDATE Bookings SET status='cancelled' WHERE id=$1 RETURNING *`,
    [bookingId]
  );

  // Make vehicle available again
  await pool.query(
    `UPDATE Vehicles SET availability_status='available' WHERE id=$1`,
    [data.vehicle_id]
  );

  return updated.rows[0];
};

const markAsReturned = async (bookingId: string) => {
  const booking = await pool.query(`SELECT * FROM Bookings WHERE id=$1`, [
    bookingId,
  ]);

  if (booking.rows.length === 0) {
    throw new Error("Booking not found");
  }

  const data = booking.rows[0];

  // update booking status
  const updated = await pool.query(
    `UPDATE Bookings SET status='returned' WHERE id=$1 RETURNING *`,
    [bookingId]
  );

  // vehicle available again
  await pool.query(
    `UPDATE Vehicles SET availability_status='available' WHERE id=$1`,
    [data.vehicle_id]
  );

  return updated.rows[0];
};

const autoReturnExpiredBookings = async () => {
  const today = dayjs().format("YYYY-MM-DD");

  // Find all bookings that ended before today and still active
  const expiredBookings = await pool.query(
    `SELECT * FROM Bookings 
             WHERE rent_end_date < $1 
             AND status='active'`,
    [today]
  );

  for (const booking of expiredBookings.rows) {
    await pool.query(`UPDATE Bookings SET status='returned' WHERE id=$1`, [
      booking.id,
    ]);

    await pool.query(
      `UPDATE Vehicles SET availability_status='available' WHERE id=$1`,
      [booking.vehicle_id]
    );
  }

  return expiredBookings.rows.length;
};

//booking controller code
export const cancelBooking = async (req: Request, res: Response) => {
    const bookingId = req.params.id;
    const customerId = (req as any).user.id;

    try {
        const result = await bookingsService.cancelBookings(bookingId!, customerId);

        return res.status(200).json({
            success: true,
            message: "Booking cancelled",
            data: result
        });

    } catch (error: any) {
        return res.status(400).json({
            success: false,
            message: error.message
        });
    }
}

const markAsReturned = async(req: Request, res: Response) => {
    const bookingId = req.params.id;
    const role = (req as any).user.role;

    if (role !== "admin") {
        return res.status(403).json({
            success: false,
            message: "Only admin can mark as returned"
        });
    }

    try {
        const result = await bookingsService.markAsReturned(bookingId!);

        return res.status(200).json({
            success: true,
            message: "Vehicle marked as returned",
            data: result
        });

    } catch (error: any) {
        return res.status(400).json({
            success: false,
            message: error.message
        });
    }
}

const autoMarkBySystem = async (req:Request, res: Response) => {
        try {
        const total = await bookingsService.autoReturnExpiredBookings();

        return res.status(200).json({
            success: true,
            message: `Auto-return completed for ${total} bookings.`
        });

    } catch (error: any) {
        return res.status(500).json({
            success: false,
            message: error.message
        });
    }

}